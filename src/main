from fastapi import FastAPI
from pydantic import BaseModel
import cohere
import json
from fastapi.middleware.cors import CORSMiddleware

# Configuração do Cohere
COHERE_API_KEY = ""
co = cohere.Client(api_key=COHERE_API_KEY)

# Base de dados expandida de tabelas e campos do Infor LN
tables = {
    # Common Data (tc)
    "tccom100": ["bpid", "nama", "namb", "ccty", "ccit", "pstc", "telp", "cdfx"],
    "tccom130": ["cadr", "nama", "pstc", "ccty", "ccit", "telp"],
    "tcemm030": ["emno", "nama", "ccty", "telf"],
    "tcmcs000": ["cmpy", "nama", "ccty"],
    "tcmcs052": ["dsca", "refr", "loco"],
    
    # Financial (tf/ti)
    "tfacr201": ["reca", "amnt", "ninv", "recd", "balc", "blca", "fire"],
    "tfacp200": ["ttyp", "ninv", "ifbp", "amti", "cmpy"],
    "tfgld010": ["dim", "dcod", "dsca"],
    "tfgld106": ["year", "peri", "amnt", "dcod"],
    
    # Sales (tdsls)
    "tdsls400": ["orno", "sqnb", "pono", "item", "dqua", "qana", "qoor", "dldt"],
    "tdsls401": ["orno", "pono", "dsca", "amnt"],
    "tdsls420": ["orno", "sqnb", "fire"],
    "tdsls094": ["ofbp", "nama"],
    
    # Purchase (tdpur)
    "tdpur400": ["orno", "pono", "sqnb", "item", "qoor", "qidl", "cprt"],
    "tdpur401": ["orno", "pono", "dsca"],
    "tdpur094": ["ofbp", "nama", "ccty"],
    
    # Inventory/Warehouse (twh/ti)
    "twhwmd215": ["item", "cwar", "qhnd", "qall", "qord"],
    "twhwmd400": ["item", "cwar", "sern", "cwar", "fire"],
    "tcibd001": ["item", "dsca", "dscb", "kitm", "csig"],
    "tcibd002": ["item", "cplt", "cpmt"],
    
    # Manufacturing (tipdm)
    "tipdm015": ["item", "cwar", "csig"],
    "tipdm600": ["maun", "stat", "item", "qmog", "pldt"],
    
    # Project (tpppc)
    "tpppc100": ["cprj", "dsca"],
    "tpppc200": ["cprj", "cact", "csub", "dsca"],
    
    # Business Partner (tccom)
    "tccom100": ["bpid", "nama", "seak", "ccty", "telp"],
    
    # Transport (tdtcr)
    "tdtcr940": ["load", "trck", "fire"],
    
    # Service (tisfc)
    "tisfc010": ["cser", "dsca"],
    
    # Sessions Tables (ttstpi)
    "ttstpi010": ["data"],
    "ttstpi030": ["data"],
}

# Campos comuns LN (padrão em múltiplas tabelas)
common_fields = [
    "t$cmpy", "t$fire", "t$user", "t$lnno", "t$seqn", 
    "t$crdt", "t$crby", "t$updt", "t$upby",
    "t$item", "t$pono", "t$orno", "t$sqnb", 
    "t$bpid", "t$cwar", "t$stat"
]

class ScriptRequest(BaseModel):
    script: str 

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

def analyze_script(script: str):
    prompt = f"""
        Você é um **validador especialista em Infor LN / Baan 4GL**.
        Atue de forma **estritamente técnica**, **determinística** e **conservadora**.
        Não faça suposições nem extrapolações fora do que está explicitamente definido abaixo.

        ---

        **ESTRUTURA DE TABELAS LN:**
        - Prefixos:
        - tc → common
        - td → logistics
        - ti → financial / inventory
        - tw → warehouse
        - tp → project
        - Sufixos numéricos indicam módulos específicos
        - Nomenclatura session-based: campos transacionais usam o prefixo `t$`
        - Campos de auditoria padrão:
        - t$crdt, t$crby, t$updt, t$upby
        - Campos de controle comuns:
        - t$cmpy, t$fire, t$user, t$lnno

        ---

        **SINTAXE 4GL VÁLIDA (USE SOMENTE ESTAS):**
        - Estruturas:
        - select ... endselect
        - selectdo ... endselect
        - selectempty ... endselect

        - Loops:
        - for ... endfor
        - while ... endwhile

        - Condicionais:
        - if ... then ... else ... endif

        - Comandos de banco de dados:
        - db.insert
        - db.update
        - db.delete
        - db.read
        - db.skip

        - Declaração de tipos:
        - domain
        - long
        - string
        - double

        - Funções built-in:
        - strip$()
        - concat$()
        - val()
        - str$()

        ⚠️ Qualquer estrutura, função ou comando fora desta lista deve ser considerado **ERRO DE SINTAXE**.

        ---

        **CATÁLOGO DE REFERÊNCIA (ÚNICA FONTE VÁLIDA):**
        {json.dumps(tables, indent=2)}

        ---

        **CAMPOS COMUNS (APLICÁVEIS A MÚLTIPLAS TABELAS):**
        {json.dumps(common_fields, indent=2)}

        ---

        **SCRIPT PARA ANÁLISE:**
        {script}

        ---

        ## INSTRUÇÕES DE ANÁLISE

        ### 1. AVALIAÇÃO INICIAL
        - Determine PRIMEIRO se existem erros de sintaxe, estrutura ou lógica
        - Se **NÃO houver erros**:
        - NÃO sugira correções
        - NÃO reescreva o código
        - Apenas explique o funcionamento
        - Se **HOUVER erros**, prossiga para a análise detalhada

        ---

        ### 2. ERROS DE SINTAXE (somente se existirem)
        - Estruturas 4GL incompletas ou mal fechadas
        - Uso de comandos inexistentes ou fora da lista permitida
        - Variáveis não declaradas
        - Tipos inválidos
        - Strings mal formadas
        - Operadores usados incorretamente

        ---

        ### 3. ERROS DE TABELAS / CAMPOS (somente se existirem)
        - Tabelas inexistentes no catálogo
        - Campos inexistentes para a tabela referenciada
        - Ausência ou uso incorreto do prefixo `t$`
        - Referência a módulos que não existem

        ---

        ### 4. ERROS DE LÓGICA (somente se existirem)
        - Operações de escrita sem critério adequado
        - Leitura sem validação posterior
        - Fluxos que podem gerar inconsistência de dados
        - Uso incorreto de comandos DB em contexto inválido

        ---

        ### 5. PARA SCRIPTS SEM ERROS
        Forneça obrigatoriamente:
        - ✅ Confirmação explícita: "Este script não possui erros de sintaxe ou lógica"
        - Explicação clara do propósito do código
        - Descrição objetiva do fluxo de execução
        - Lista de tabelas e campos utilizados
        - Melhorias de performance **somente se forem neutras e opcionais**

        ---

        ### 6. PARA SCRIPTS COM ERROS
        Forneça obrigatoriamente:
        - Lista detalhada de erros
        - Motivo técnico de cada erro
        - Recomendação específica de correção
        - Versão corrigida do script completo
        - Não altere a lógica de negócio original

        ---

        ## REGRAS CRÍTICAS
        - ❌ NÃO invente tabelas, campos ou sintaxe
        - ❌ NÃO corrija código que já esteja correto
        - ❌ NÃO altere a lógica funcional
        - ✅ Use apenas o catálogo fornecido
        - ✅ Seja preciso, técnico e direto
        - ✅ Respeite a sintaxe estrita do Infor LN
        - ✅ Considere compatibilidade com LN On-Premise e Cloud Edition

        ---

        ## FORMATO DE RESPOSTA
        - **Sem erros** → confirmação + explicação funcional
        - **Com erros** → análise técnica + código corrigido
        """


    response = co.chat(
        model="command-r-plus-08-2024",
        message=prompt,
        temperature=0.1,
        max_tokens=4000
    )
    return response.text

@app.post("/analyze")
async def analyze(request: ScriptRequest):
    result = analyze_script(request.script)
    return {"analysis": result}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
