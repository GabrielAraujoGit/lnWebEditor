<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>LN Validator Chat</title>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism-tomorrow.css" rel="stylesheet" />
<style>
body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
}
header {
    background: #0078D7;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 1.2em;
}
#chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #e5e5e5;
}
.message {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
    white-space: pre-wrap;
    position: relative;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
}
.message.show {
    opacity: 1;
    transform: translateY(0);
}
.user {
    background: #0078D7;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
}
.bot { align-self: flex-start; border-bottom-left-radius: 0; }
.syntax { background: #ffe6e6; border-left: 5px solid #ff4d4d; color: #000; }
.missing { background: #fff4cc; border-left: 5px solid #ffcc00; color: #000; }
.structure { background: #e6f7ff; border-left: 5px solid #3399ff; color: #000; }
.recommendation { background: #e6ffe6; border-left: 5px solid #33cc33; color: #000; }
.corrected { background: #f0f0f0; border-left: 5px solid #999; color: #000; }
.copy-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 3px 6px;
    font-size: 12px;
    cursor: pointer;
    background: #0078D7;
    color: white;
    border: none;
    border-radius: 3px;
}
#input-area {
    display: flex;
    padding: 10px;
    background: #ffffff;
    border-top: 1px solid #ccc;
    gap: 10px;
    align-items: flex-end;
}
#script {
    flex: 1;
    padding: 12px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 20px;
    resize: none;
    height: 60px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    transition: border 0.2s, box-shadow 0.2s;
}
#script:focus {
    border-color: #0078D7;
    box-shadow: 0 0 5px rgba(0,120,215,0.4);
    outline: none;
}
#sendBtn {
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    background: #0078D7;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s, transform 0.1s;
}
#sendBtn:hover { background: #005bb5; transform: translateY(-1px); }
#sendBtn:active { transform: translateY(1px); }
#sendBtn:disabled { background: #999; cursor: not-allowed; }
.typing {
    display: inline-block;
    width: 8px;
    height: 8px;
    margin: 0 2px;
    background: #0078D7;
    border-radius: 50%;
    animation: blink 1s infinite;
}
@keyframes blink {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
}
pre { margin: 0; }
</style>
</head>
<body>

<header>LN Validator Chat</header>
<div id="chat"></div>

<div id="input-area">
    <textarea id="script" placeholder="Digite seu script LN aqui... Enter para enviar, Shift+Enter para nova linha"></textarea>
    <button id="sendBtn">Enviar</button>
    <span class="loading" id="loading" style="display:none;">Carregando...</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/prism.js"></script>
<script>
Prism.languages.ln = {
    'keyword': /\b(function|select|from|where|endselect|if|then|else|endif|continue|return)\b/g,
    'number': /\b\d+(\.\d+)?\b/g,
    'string': /("|')(?:\\.|[^\n\\])*?\1/g,
    'comment': /\|.*$/gm
};

const chat = document.getElementById('chat');
const btn = document.getElementById('sendBtn');
const loading = document.getElementById('loading');
const scriptEl = document.getElementById('script');

function createTypingMessage() {
    const div = document.createElement('div');
    div.className = 'message bot';
    div.innerHTML = '<span class="typing"></span><span class="typing"></span><span class="typing"></span>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

function appendBotMessage(text) {
    const typingDiv = createTypingMessage();
    // Simular tempo de digitação
    setTimeout(() => {
        chat.removeChild(typingDiv);
        const sections = text.split('\n\n');
        sections.forEach(line => {
            let cssClass = '';
            const lower = line.toLowerCase();
            if (lower.includes('erro') || lower.includes('syntax')) cssClass = 'syntax';
            else if (lower.includes('campo inexistente')) cssClass = 'missing';
            else if (lower.includes('estrutura')) cssClass = 'structure';
            else if (lower.includes('recomenda')) cssClass = 'recommendation';
            else if (lower.includes('versão corrigida')) cssClass = 'corrected';

            const div = document.createElement('div');
            div.className = `message bot ${cssClass}`;
            div.innerHTML = marked.parse(line);
            div.classList.add('show');

            if (cssClass === 'corrected') {
                const btnCopy = document.createElement('button');
                btnCopy.className = 'copy-btn';
                btnCopy.innerText = 'Copiar';
                btnCopy.onclick = () => navigator.clipboard.writeText(line);
                div.appendChild(btnCopy);
            }
            chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
        chat.querySelectorAll('code').forEach(block => Prism.highlightElement(block));
    }, 800 + Math.random()*500);
}

function appendUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'message user show';
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

async function sendScript() {
    const script = scriptEl.value.trim();
    if (!script) return;

    appendUserMessage(script);
    btn.disabled = true;
    loading.style.display = 'inline';

    try {
        const response = await fetch('http://127.0.0.1:8000/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ script })
        });
        if (!response.ok) throw new Error(`Erro na requisição: ${response.status}`);
        const data = await response.json();
        appendBotMessage(data.analysis);
    } catch (err) {
        appendBotMessage(`Ocorreu um erro: ${err.message}`);
    } finally {
        btn.disabled = false;
        loading.style.display = 'none';
        scriptEl.value = '';
    }
}

scriptEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        btn.click();
    }
});

btn.addEventListener('click', sendScript);
</script>

</body>
</html>
